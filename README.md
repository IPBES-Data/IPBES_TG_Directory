# IPBES Technical Guideline Directory

This repository hosts the source for the public directory of IPBES Technical Guidelines (TGs). The directory is a Quarto site that lists every TG published under the IPBES-Data organisation, pulling shared metadata from each guideline repository and rendering an index page that highlights availability, DOIs, abstracts and target audiences.

## Repository layout
- `index.qmd` – Quarto source for the directory landing page. It embeds the generated TG listing and supplies the page narrative and styling options.
- `figures/` – Icon SVGs that label the target audience for each TG (experts, TSUs, secretariat, etc.). Referenced from both the Quarto page and generated listings.
- `scripts/` – Utility scripts that keep the listing in sync with upstream TG repositories and help CI detect dependencies. The `not_used/` subdirectory contains earlier experiments kept for reference only.

## Key workflows

### Refresh the TG listing
`generate_directory_from_remote.R` discovers every public repository in `IPBES-Data` whose name starts with `IPBES_TG_` (except this directory). It downloads the `metadata_qmd.yaml` file exposed by each project’s GitHub Pages site. It normalises category tags to icons, adds DOI badges and abstracts, and writes the combined catalogue to `generated/tg_list.md`.

Run it from the repository root:

```bash
Rscript scripts/generate_directory_from_remote.R
```

### Export page front matter
`export_frontmatter.sh` pulls the YAML header from `index.qmd` and rewrites it into `metadata_qmd.yaml`. This is useful when other automation only needs the page metadata without parsing the full Quarto document.

```bash
./scripts/export_frontmatter.sh index.qmd
```

The script defaults to the first `.qmd` file in the directory if no argument is given.

### Detect R dependencies for CI
`detect_r_packages.sh` scans one or more Quarto files to decide whether R code is used, and if so which packages are referenced. When it finds R usage it writes a `R.pkgs` manifest, letting CI set up only the required packages before calling Quarto.

```bash
./scripts/detect_r_packages.sh index.qmd
```

If every file is marked `eval: false`, the script lists only `knitr` and `rmarkdown`; otherwise it adds any libraries detected via `library()`, `require()` or `pkg::func` calls.

## Generated artefacts
- `metadata_qmd.yaml` is derived from `index.qmd` via `export_frontmatter.sh`. Do not edit it manually—regenerate it after adjusting the Quarto front matter.
- `generated/tg_list.md` is regenerated by `generate_directory_from_remote.R`. Manual edits will be overwritten the next time the script runs.

## Building the site
1. Ensure Quarto is available locally (https://quarto.org/docs/get-started/).
2. Refresh `generated/tg_list.md` if required.
3. Run `quarto render` in the repository root to rebuild `index.html`.

The rendered `index.html` can then be published through GitHub Pages or any static host.

## GitHub workflow
- Runs on pushes to `main` or `master`, a nightly cron (`0 0 * * *`) and manual `workflow_dispatch` triggers.
- Executes the R automation first: regenerates `generated/tg_list.md`, exports front matter, and records any R package usage for CI.
- Installs Quarto and, when `R.pkgs` exists, installs the detected R packages before rendering `index.qmd` to `index.html`.
- Copies the rendered outputs plus supporting files into a temporary `public/` directory.
- Publishes `public/` to the `gh-pages` branch using `peaceiris/actions-gh-pages@v3` with Jekyll disabled.

## Additional notes
- Icons in `figures/` must keep their filenames because the generated listing expects specific names (for example `icon-expert.svg`).
- When adding a new TG repository under `IPBES-Data`, make sure it uses te `IPBES_TG_TEMPATE` template which contains all functionality needed on the TG side, i.e. extracts `metadata_qmd.yaml` on GitHub Pages so it appears automatically in the directory the next time the listing is refreshed and publishes the website.
- The github action `quarto-gh-pages.yml ` in `.github/workflows/` is executed upon push to main as well as each day at 00:00 UTC to ensure the directory is always up to date.
